service: moviedb-backend

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'prod'}
  environment:
    NODE_ENV: production
    RDS_ENDPOINT: ${env:RDS_ENDPOINT}
    RDS_PASSWORD: ${env:RDS_PASSWORD}
    APP_DB_PASSWORD: ${env:APP_DB_PASSWORD}
    JWT_SECRET: ${env:JWT_SECRET}
    CORS_ORIGIN: ${env:CORS_ORIGIN}
    DB_SSL: true
  vpc:
    securityGroupIds:
      - sg-0563f4fe5404ecb98
    subnetIds:
      - subnet-0dea14ff596c46078
      - subnet-0ae8e73715edb5335
  iamRoleStatements:
    - Effect: Allow
      Action:
        - rds-db:connect
        - rds:DescribeDBInstances
        - ec2:CreateNetworkInterface
        - ec2:DescribeNetworkInterfaces
        - ec2:DeleteNetworkInterface
      Resource: "*"

useDotenv: true

plugins:
  - serverless-offline
  - serverless-dotenv-plugin

functions:
  # Temporary function to create database tables
  createTables:
    handler: src/handlers/create-tables.createTables
    timeout: 30

  # Temporary function to fix database permissions
  fixPermissions:
    handler: src/handlers/fix-permissions.fixPermissions
    timeout: 30

  # Authentication
  register:
    handler: src/handlers/auth.register
    events:
      - http:
          path: /auth/register
          method: post
          cors:
            origin: 'https://mymoviepalour.netlify.app'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false

  login:
    handler: src/handlers/auth.login
    events:
      - http:
          path: /auth/login
          method: post
          cors:
            origin: 'https://mymoviepalour.netlify.app'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false

  # User Profile
  getProfile:
    handler: src/handlers/user.getProfile
    events:
      - http:
          path: /user/profile
          method: get
          cors:
            origin: 'https://mymoviepalour.netlify.app'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false

  updateProfile:
    handler: src/handlers/user.updateProfile
    events:
      - http:
          path: /user/profile
          method: put
          cors:
            origin: 'https://mymoviepalour.netlify.app'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false

  # Favorites
  getFavorites:
    handler: src/handlers/favorites.getFavorites
    events:
      - http:
          path: /user/favorites
          method: get
          cors:
            origin: 'https://mymoviepalour.netlify.app'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false

  addFavorite:
    handler: src/handlers/favorites.addFavorite
    events:
      - http:
          path: /user/favorites
          method: post
          cors:
            origin: 'https://mymoviepalour.netlify.app'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false

  removeFavorite:
    handler: src/handlers/favorites.removeFavorite
    events:
      - http:
          path: /user/favorites/{id}
          method: delete
          cors:
            origin: 'https://mymoviepalour.netlify.app'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false